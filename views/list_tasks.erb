<!DOCTYPE html>
<html>

<head>
  <title>Memory stats</title>
  <%= erb :css %>
</head>

<body>
  <p id="date-nav-links">
    <% if running %>
      Current jobs
    <% else %>
      <a href="/" class="date-nav-link">Current jobs</a>
    <% end %>
    <% dates.reverse.each do |the_date| %>
      <% if not current_job and not running and date == the_date %>
        - <%= the_date %>
      <% else %>
        - <a href="/<%= the_date %>/" class="date-nav-link"><%= the_date %></a>
      <% end %>
    <% end %>
  </p>

  <% if current_job %>
    <h1>Memory stats for job <%= current_job %> on <%= date %></h1>
    <p>Memory used by this job over time.</p>
  <% elsif running %>
    <h1>Current memory allocation</h1>
  <% else %>
    <h1>Memory stats for <%= date %></h1>
    <p>Click a job ID to look at memory usage over time.</p>
  <% end %>

  <% if current_job %>
    <p class="mem-chart">
      <%=
        mems = stats.map do |job_id, job|
          # cur           max           req
          [ job[10].to_f, job[11].to_f, job[5].to_f ]
        end

        max_mem = mems.map{|a|a.max}.max || 1
        scaling = 50 / max_mem
        width = [ 1, [ 400 / mems.size, 5 ].min ].max rescue 1

        mems.reverse.map do |cur, max, req|
          cur = (cur * scaling).to_i
          max = (max * scaling).to_i - cur
          req = (req * scaling).to_i - (max + cur)
          "<span class=\"entry\" style=\"width:#{width}px;\">" +
          ((req > 0) ? "<span class=\"mbar-req\" style=\"width:#{width}px; height:#{ req }px\"></span>" : "") +
          ((max > 0) ? "<span class=\"mbar-max\" style=\"width:#{width}px; height:#{ max }px\"></span>" : "") +
          ((cur > 0) ? "<span class=\"mbar-cur\" style=\"width:#{width}px; height:#{ cur }px\"></span>" : "") +
          "</span>"
        end.join
      %>
    </p>
  <% end %>

  <% if running %>
    <table cellspacing="0" class="total-cluster-mbar">
      <tr>
        <th colspan="3">
          Current memory allocation (sum of all running jobs)
        </th>
      </tr>
      <tr>
      <%
        total_cur = 0
        total_max = 0
        total_req = 0
        mems = stats.map do |job_id, job|
          total_cur += job[10].to_f
          total_max += job[11].to_f
          total_req += job[5].to_f
        end

        max_mem = 1024*1024*1024*1260
        # vmem current
        vmem_cur_pix = (600 * (total_cur.to_f / max_mem)).to_i
        # vmem max
        vmem_max_pix = (600 * (total_max.to_f / max_mem)).to_i
        # vmem requested
        vmem_req_pix = (600 * (total_req.to_f / max_mem)).to_i
        %><td><span class="mbar-cur" style="width: <%= vmem_cur_pix %>px"></span></td><%
        if vmem_max_pix > vmem_cur_pix
          %><td><span class="mbar-max" style="width: <%= vmem_max_pix - vmem_cur_pix %>px"></span></td><%
        end
        if vmem_req_pix > vmem_max_pix
          %><td><span class="mbar-req" style="width: <%= vmem_req_pix - vmem_max_pix %>px"></span></td><%
        end

        %></tr><tr><%

        %><td><%= format_mem(total_cur) %> MB</td><%
        if vmem_max_pix > vmem_cur_pix
          %><td><%= format_mem(total_max - total_cur) %> MB</td><%
        end
        if vmem_req_pix > vmem_max_pix
          %><td><%= format_mem(total_req - total_max) %> MB</td><%
        end
      %>
      </tr>
      <tr>
        <td>in use by running jobs</td>
        <td>&nbsp;</td>
        <td>requested, but never actually used</td>
      </tr>
    </table>

    <h1>Current jobs</h1>
    <p>Click a job ID to look at memory usage over time.</p>
  <% end %>

  <table cellspacing="0" class="legend">
    <tr><td><span class="mbar-cur" style="width: 50px"></span></td><td>VMemCurrent</td><td>current memory usage</td></tr>
    <tr><td><span class="mbar-max" style="width: 50px"></span></td><td>VMemMax</td><td>maximum memory usage</td></tr>
    <tr><td><span class="mbar-req" style="width: 50px"></span></td><td>VMemRequested</td><td>requested memory</td></tr>
  </table>

  <% if current_job and next_date(date) %>
    <p><a href="/<%= next_date(date) %>/<%=h current_job %>">Look for this job on the next day</a></p>
  <% end %>
  <% if current_job and previous_date(date) %>
    <p><a href="/<%= previous_date(date) %>/<%=h current_job %>">Look for this job on the previous day</a></p>
  <% end %>

  <form action="#" method="post" id="table-filter">
  <table cellspacing="0" class="stats">
    <thead>
      <tr>
        <th>Time</th>
        <th>Job</th>
        <th>Owner</th>
        <th>Name</th>
        <th>Queue</th>
        <th class="r">VMemRequested</th>
        <th class="r">VMemCurrent</th>
        <th class="r">VMemMax</th>
        <th>&nbsp;</th>
      </tr>
      <% if not current_job %>
        <tr id="table-filter-input-row">
          <td>&nbsp;</td>
          <td><input type="search" placeholder="Filter" class="filter" size="1" name="jobid" value="<%=h params["jobid"] %>" /></td>
          <td><input type="search" placeholder="Filter" class="filter" size="1" name="owner" value="<%=h params["owner"] %>" /></td>
          <td><input type="search" placeholder="Filter" class="filter" size="1" name="jobname" value="<%=h params["jobname"] %>" /></td>
          <td><input type="search" placeholder="Filter" class="filter" size="1" name="queue" value="<%=h params["queue"] %>" /></td>
          <td>&nbsp;</td>
          <td>&nbsp;</td>
          <td>&nbsp;</td>
          <td>&nbsp;</td>
        </tr>
      <% end %>
    </thead>
    <tbody>
      <%
        job_id_filter = params[:jobid].to_s.downcase.strip
        job_id_filter = nil if job_id_filter == ""
        owner_filter = params[:owner].to_s.downcase.strip
        owner_filter = nil if owner_filter == ""
        jobname_filter = params[:jobname].to_s.downcase.strip
        jobname_filter = nil if jobname_filter == ""
        queue_filter = params[:queue].to_s.downcase.strip
        queue_filter = nil if queue_filter == ""

        stats.each do |job_id, job|
          matches_filter = (
            (job_id_filter.nil? || job_id.to_s.downcase.include?(job_id_filter))   &&
            (owner_filter.nil? || job[3].to_s.downcase.include?(owner_filter))     &&
            (jobname_filter.nil? || job[4].to_s.downcase.include?(jobname_filter)) &&
            (queue_filter.nil? || job[12].to_s.downcase.include?(queue_filter))
          )
      %>
        <tr<% unless matches_filter %> style="display:none"<% end %>>
          <td><%= Time.at(job[0].to_i).localtime.strftime("%Y-%m-%d %H:%M:%S") %></td>
          <% if current_job %>
            <td><%=h job_id %></td>
          <% else %>
            <td><a href="/<%= date %>/<%=h job_id %>"><%=h job_id %></a></td>
          <% end %>
          <td><%=h job[3] %></td>
          <td><%=h job[4] %></td>
          <td><%=h job[12].to_s.sub(/^p[0-9]+_/, "") %></td>
          <%=
            # memory
            [ 5, 10, 11 ].map do |i|
              "<td class=\"r\">#{ format_mem(job[i]) } MB</td>"
            end.join
          %>
          <td class="mbar"><nobr><%
            # vmem current
            vmem_cur_pix = (200 * (job[10].to_f / (1024*1024*1024*12))).to_i
            # vmem max
            vmem_max_pix = (200 * (job[11].to_f / (1024*1024*1024*12))).to_i
            # vmem requested
            vmem_req_pix = (200 * (job[5].to_f  / (1024*1024*1024*12))).to_i
            %><span class="mbar-cur" style="width: <%= vmem_cur_pix %>px"></span><%
            if vmem_max_pix > vmem_cur_pix
              %><span class="mbar-max" style="width: <%= vmem_max_pix - vmem_cur_pix %>px"></span><%
            end
            if vmem_req_pix > vmem_max_pix
              %><span class="mbar-req" style="width: <%= vmem_req_pix - vmem_max_pix %>px"></span><%
            end
          %></nobr></td>
        </tr>
      <% end %>
    </tbody>
  </table>
  </form>
  <% if current_job and previous_date(date) %>
    <p><a href="/<%= previous_date(date) %>/<%=h current_job %>">Look for this job on the previous day</a></p>
  <% end %>
</body>
</html>

